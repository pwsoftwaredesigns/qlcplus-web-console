<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/bootstrap-icons.min.css">
		<link rel="stylesheet" href="css/fader.css">

		<script src="js/jquery.min.js"></script>
		<script src="js/Fader.js"></script>
		<script src="js/QLCPlus.js"></script>
		<script src="js/bootstrap.bundle.min.js"></script>
		<script src="js/theme.js"></script>

		<title>QLC+</title>

		<style>
			#scenes tr {
				cursor: pointer;
			}

			.scene-active {
				background-color: #04AA6D;
				--bs-table-bg-state: #04AA6D;
			}

			.scene-active:hover {
				background-color: #04AA6D;
				--bs-table-bg-state: #04AA6D;
			}

			.btn-scene {
				width: 33%;
			}

			#tableScenes {
				max-height: 70vh;
			}

			.form-check-input {
				clear: left;
			}

			.form-switch.form-switch-sm .form-check-input {
				height: 1rem;
				width: calc(1rem + 0.75rem);
				border-radius: 2rem;
			}

			.form-switch.form-switch-md .form-check-input {
				height: 1.5rem;
				width: calc(2rem + 0.75rem);
				border-radius: 3rem;
			}

			.form-switch.form-switch-lg .form-check-input {
				height: 2rem;
				width: calc(3rem + 0.75rem);
				border-radius: 4rem;
			}

			.form-switch.form-switch-xl .form-check-input {
				height: 2.5rem;
				width: calc(4rem + 0.75rem);
				border-radius: 5rem;
			}
		</style>

		<script type="text/javascript" oncontextmenu="return false;">
			//-----[ CLASS: Scene ]---------------------------------------------
			class Scene
			{
				static toData(scene)
				{
					return scene;
				}

				static fromData(data)
				{
					let scene = new Scene(data["name"]);
					scene.values = data["values"];
					scene.duration = data["duration"];

					return scene;
				}

				constructor(name)
				{
					this.name = name; //User-defined name for the scene
					this.values = null; //Values to which faders are set
					this.duration = 1000; //Time (in ms) to fade to this scene
				}

				/**
				* @return The user-editable attributes of the scene as a
				*         javascript object
				*/
				attributes()
				{
					return {
						name: this.name,
						duration: this.duration
					};
				}

				/**
				* @brief Set the user-editable attributes of the scene
				*/
				setAttributes(attributes)
				{
					if (attributes.hasOwnProperty("name")) this.name = attributes["name"]
					if (attributes.hasOwnProperty("duration")) this.duration = attributes["duration"];
				}

				/**
				* @brief Fade the given set of faders to this scene
				*/
				fadeTo(faders)
				{
					if (this.values)
					{
						for (let i = 0; i < faders.length; i++)
						{
							faders[i].fade(this.values[i], this.duration);
						}
					}
				}

			} //class Scene

			//-----[ CLASS: SceneUI ]-------------------------------------------
			class SceneUI
			{
				constructor(scene, trElement)
				{
					this.scene = scene;
					this.trElement = trElement;
					this.trElement.onclick = this.onClicked.bind(this);

					let tdElement = $("<td class='scene-edit'></td>");
					let btnGroupElement = $("<div class='btn-group'></div>");

					let btnSave = $("<button type='button' class='btn btn-primary'><i class='bi-floppy'></i></button>");
					btnSave.click(function(e){
						e.stopPropagation();
						
						confirmModal(
							"Save Scene", 
							"Are you sure you want to save the current fader values to this scene?", 
							function(){
								saveScene(this.scene);
							}.bind(this)
						);
						
						
					}.bind(this));
					btnGroupElement.append(btnSave);
					
					let btnEdit = $("<button type='button' class='btn btn-primary'><i class='bi-pencil'></i></button>");
					btnEdit.click(function(e){
						e.stopPropagation();
						editScene(this.scene);
					}.bind(this));
					btnGroupElement.append(btnEdit);

					let btnRemove = $("<button type='button' class='btn btn-danger'><i class='bi-trash'></i></button>");
					btnRemove.click(function(e){
						e.stopPropagation();
						
						confirmModal(
							"Delete Scene", 
							"Are you sure you want to delete this scene?", 
							function(){
								removeScene(this.scene);
							}.bind(this)
						);
					}.bind(this));
					btnGroupElement.append(btnRemove);
					tdElement.append(btnGroupElement);
					
					let btnGroupMoveElement = $("<div class='btn-group ms-2'></div>");
					
					let btnMoveUp = $("<button type='button' class='btn btn-secondary'><i class='bi-arrow-up'></i></button>");
					btnMoveUp.click(function(e){
						e.stopPropagation();
						moveSceneUp(this.scene);
					}.bind(this));
					btnGroupMoveElement.append(btnMoveUp);
					
					let btnMoveDown = $("<button type='button' class='btn btn-secondary'><i class='bi-arrow-down'></i></button>");
					btnMoveDown.click(function(e){
						e.stopPropagation();
						moveSceneDown(this.scene);
					}.bind(this));
					btnGroupMoveElement.append(btnMoveDown);
					
					tdElement.append(btnGroupMoveElement);
					
					this.trElement.appendChild(tdElement[0]);
				}

				makeActive()
				{
					this.trElement.classList.add("scene-active");
				}

				makeInactive()
				{
					this.trElement.classList.remove("scene-active");
				}

				onClicked()
				{
					onSceneClicked(this.scene);
				}
			}

			var qlc = new QLCPlus();
			var scenes = [];
			var faders = [];
			var gmFader = null;
			var currentSceneIndex = null;
			var sceneUIs = [];
			var sceneMode = "edit";
			var editSceneModal = null;
			
			function confirmModal(title, message, callback)
			{
				let confirmModal = new bootstrap.Modal("#confirmModal", {
					focus: true
				});
				$("#confirmModal .modal-title").text(title);
				$("#confirmModal .modal-body p").text(message);
				$("#confirmModal .modal-okay").one('click', function(){
					callback();
					confirmModal.hide();
				});
				
				confirmModal.show();
			}

			//-----[ FUNCTION: onChannelInput ]---------------------------------
			/**
			* @brief Handle a channel fader change
			*/
			function onChannelInput(self)
			{
				var channel = self.channel;
				var val = self.value;

				try
				{
					if (channel == 0)
					{
						qlc.setGrandMaster(val);
					}
					else
					{
						qlc.setSimpleDeskChannel(channel, val);
					}

				}
				catch(e)
				{
					//console.error(e);
				}
			}

			//-----[ FUNCTION: updateSceneTable ]-------------------------------
			/**
			* @brief Populate the table of scenes
			*/
			function updateSceneTable()
			{
				var scenesTable = document.getElementById("scenes");

				scenesTable.innerHTML = "";
				sceneUIs = [];

				for (let i = 0; i < scenes.length; i++)
				{
					var row = document.createElement("tr");
					scenesTable.appendChild(row);

					var colName = document.createElement("td");
					colName.textContent = scenes[i].name;
					row.appendChild(colName);

					var colTransition = document.createElement("td");
					colTransition.textContent = scenes[i].duration;
					row.appendChild(colTransition);

					sceneUIs.push(new SceneUI(i, row));
				}

				currentSceneIndex = null;
			} //function updateSceneTable

			//-----[ FUNCTION: newScene ]---------------------------------------
			/**
			* @brief Create a new scene with the given name
			*/
			function newScene(name)
			{
				var nextSceneNumber = scenes.length + 1;

				scenes.push(new Scene("Scene " + nextSceneNumber));
				//Save the current fader settings to the new scene
				saveScene(scenes.length - 1);
				updateSceneTable();

				persistScenes();
			} //function newScene
			
			function arrayMove(arr, from, to)
			{
				var element = arr[from];
			    arr.splice(from, 1);
			    arr.splice(to, 0, element);
			}
			
			//-----[ FUNCTION: moveSceneUp ]------------------------------------
			function moveSceneUp(index)
			{
				if (index > 0)
				{
					arrayMove(scenes, index, index - 1);
					updateSceneTable();
					persistScenes();
				}
			}
			
			//-----[ FUNCTION: moveSceneDown ]----------------------------------
			function moveSceneDown(index)
			{
				if (index < scenes.length - 1)
				{
					arrayMove(scenes, index, index + 1);
					updateSceneTable();
					persistScenes();
				}
			}

			//-----[ FUNCTION: removeScene ]------------------------------------
			/**
			* @brief Delete a scene
			*/
			function removeScene(index)
			{
				scenes.splice(index, 1);
				updateSceneTable();
				persistScenes();

				console.log("Removed scene " + index);
			} //function newScene

			//-----[ FUNCTION: persistScenes ]----------------------------------
			/**
			* @brief Persist scenes to local storeage
			*/
			function persistScenes()
			{
				localStorage.setItem("scenes", JSON.stringify(scenes));
			} //function persistScenes

			//-----[ FUNCTION: restoreScenes ]----------------------------------
			function restoreScenes()
			{
				let savedScenes = localStorage.getItem("scenes");
				if (savedScenes)
				{
					let data = JSON.parse(savedScenes);
					scenes = [];
					for (let i = 0; i < data.length; i++)
					{
						scenes.push(Scene.fromData(data[i]));
					}

					updateSceneTable();
				}
			}

			//-----[ FUNCTION: init ]-------------------------------------------
			/**
			* @brief Initialize the application
			*/
			function init()
			{
				//Grand Master
				const gmFaderElement = document.querySelectorAll('#gm');
				gmFader = new Fader(gmFaderElement[0]);

				//Channels
				const faderElements = document.querySelectorAll('#faders > .fader');
				for (let i = 0; i < faderElements.length; i++)
				{
					var fader = new Fader(faderElements[i]);
					faders.push(fader);
				}

				$('input[type=radio][name=selectMode]').change(function() {
					setSceneMode(this.value);
				});
				
				$('input[type=radio][name=lock]').change(function() {
					setLock(this.value == "true");
				});

				$("#btnEditSceneSave").click(function(){
					var fields = document.querySelector("#formEditScene input");
					var attributes = {};
					$("#formEditScene input").each(function(){
						attributes[this.name] = this.value;
					});

					const index = $("#formEditScene input[name='scene']").val();
					console.log("Setting scene " + index + " attributes");
					scenes[index].setAttributes(attributes);
					editSceneModal.hide();
					persistScenes();
					updateSceneTable();
				});
				
				$("#formEditScene .btn-quick-duration").click(function(){
					$("#formEditScene input[name='duration']").val(this.value);
				});
				
				setSceneMode(sceneMode);

				//Saved scenes
				restoreScenes();
			}
			
			//-----[ FUNCTION: setLock ]----------------------------------------
			function setLock(locked)
			{		
				gmFader.setLocked(locked);
						
				for (let i = 0; i < faders.length; i++)
				{
					faders[i].setLocked(locked);
				}
			}
			
			//-----[ FUNCTION: setSceneMode ]-----------------------------------
			function setSceneMode(mode)
			{
				sceneMode = mode;
				
				console.log("Scene mode changed to " + mode);

				if (mode == "edit")
				{
					$(".scene-edit").css({"visibility":"visible", "display":""});
					$(".scene-run").css({"visibility":"hidden", "display":"none"});
				}
				else if (sceneMode == "run")
				{
					$(".scene-edit").css({"visibility":"hidden", "display":"none"});
					$(".scene-run").css({"visibility":"visible", "display":""});
				}
			}
			
			function scrollToScene(index)
			{
				const kBuffer = 100;
				
				let table = $("#tableScenes");
				let tr = $(sceneUIs[index].trElement);
				let trTop = tr.position().top;
				
				let diff = trTop - table.height() + kBuffer;
				
				$("#tableScenes").scrollTop((diff > 0) ? trTop : 0);
			}

			//-----[ FUNCTION: selectScene ]------------------------------------
			/**
			* @brief Change to the given scene
			*/
			function selectScene(index)
			{
				console.log("Select Scene " + index);

				currentSceneIndex = index;

				if (index < sceneUIs.length)
				{
					for (let i = 0; i < sceneUIs.length; i++)
					{
						sceneUIs[i].makeInactive();
					}
					sceneUIs[index].makeActive();

					scenes[index].fadeTo(faders);
				}
			}

			//-----[ FUNCTION: nextScene ]--------------------------------------
			/**
			* @brief Change to the next scene in the list
			*/
			function nextScene()
			{
				if (sceneUIs.length > 0) {
					if (currentSceneIndex !== null) {
						currentSceneIndex += 1;
					} else {
						currentSceneIndex = 0;
					}

					if (currentSceneIndex >= sceneUIs.length) {
						currentSceneIndex = 0;
					}

					selectScene(currentSceneIndex);
					scrollToScene(currentSceneIndex);
				}
			}

			//-----[ FUNCTION: prevScene ]--------------------------------------
			/**
			* @brief Change to the previous scene in the list
			*/
			function prevScene()
			{
				if (sceneUIs.length > 0) {
					if (currentSceneIndex !== null) {
						currentSceneIndex -= 1;
					} else {
						currentSceneIndex = sceneUIs.length - 1;
					}

					if (currentSceneIndex < 0) {
						currentSceneIndex = sceneUIs.length - 1;
					}

					selectScene(currentSceneIndex);
					scrollToScene(currentSceneIndex);
				}
			}

			//-----[ FUNCTION: saveScene ]--------------------------------------
			/**
			* @brief Save the current fader settings to the scene at the given
			*        index.
			*/
			function saveScene(index)
			{
				if (index < scenes.length)
				{
					console.log("Saving faders to scene " + index);
					scenes[index].values = [];
					for (let i = 0; i < faders.length; i++)
					{
						scenes[index].values[i] = faders[i].value;
					}
					persistScenes();
				}
			}

			function editScene(index)
			{
				//Populate the modal
				const scene = scenes[index];
				const attributes = scene.attributes();
				for (const key in attributes)
				{
					var inputField = document.querySelector("#formEditScene input[name='" + key + "']");
					if (inputField)
					{
						inputField.value = attributes[key];
					}
				}
				document.querySelector("#formEditScene input[name='scene']").value = index;

				//Show the modal
				editSceneModal = new bootstrap.Modal("#editSceneModal", {
					focus: true
				});
				editSceneModal.show();
			}

			//-----[ FUNCTION: onSceneClicked ]---------------------------------
			function onSceneClicked(index)
			{
				if (sceneMode == "edit")
				{
					//editScene(index);
				}
				else if (sceneMode == "run")
				{
					selectScene(index);
				}
			}

		</script>
	</head>
	<!--oncontextmenu="return false;"-->
	<body onload="init()" oncontextmenu="return false;">
		<!-- Navbar -->
		<div class="navbar navbar-expand-lg bg-body-tertiary d-flex justify-content-between">
			<!-- Connect button -->
			<div class="">
				<button class="btn btn-secondary" onclick="qlc.connect('127.0.0.1:9999')">Connect</button>
			</div>
			
			<!-- Lock/Unlock switch -->
			<div class="btn-group" role="group">
				<input type="radio" class="btn-check" name="lock" autocomplete="off" value="false" id="lockNo" checked>
				<label class="btn btn-secondary" for="lockNo"><i class="bi-unlock"></i></label>

				<input type="radio" class="btn-check" name="lock" autocomplete="off" value="true" id="lockYes">
				<label class="btn btn-secondary" for="lockYes"><i class="bi-lock"></i></label>
			</div>

			<!-- Dark mode switch -->
			<div class="form-check form-switch form-switch-lg d-flex">
				<input class="form-check-input" type="checkbox" role="switch" id="switchDarkMode" data-bs-theme-value="dark">
				<label class="form-check-label" for="flexSwitchCheckDefault">Dark Mode</label>
			</div>
		</div>

		<div class="container-fluid">
			<div class="row">
				<div class="col-1 p-2">
					<div class="fader-container d-flex justify-content-center">
						<div class="fader" id="gm" channel="0" value="255" max="255" onValueChanged="onChannelInput" label="GM"></div>
					</div>
				</div>

				<!-- Faders -->
				<div class="col-8 p-2">
					<div class="fader-container d-flex justify-content-center" id="faders">
						<div class="fader" id="channel1" channel="1" value="0" max="255" onValueChanged="onChannelInput" label="1"></div>
						<div class="fader" id="channel2" channel="2" value="0" max="255" onValueChanged="onChannelInput" label="2"></div>
						<div class="fader" id="channel3" channel="3" value="0" max="255" onValueChanged="onChannelInput" label="3"></div>
						<div class="fader" id="channel4" channel="4" value="0" max="255" onValueChanged="onChannelInput" label="4"></div>
						<div class="fader" id="channel5" channel="5" value="0" max="255" onValueChanged="onChannelInput" label="5"></div>
						<div class="fader" id="channel6" channel="6" value="0" max="255" onValueChanged="onChannelInput" label="6"></div>
						<div class="fader" id="channel7" channel="7" value="0" max="255" onValueChanged="onChannelInput" label="7"></div>
						<div class="fader" id="channel8" channel="8" value="0" max="255" onValueChanged="onChannelInput" label="8"></div>
						<div class="fader" id="channel9" channel="9" value="0" max="255" onValueChanged="onChannelInput" label="9"></div>
						<div class="fader" id="channel10" channel="10" value="0" max="255" onValueChanged="onChannelInput" label="10"></div>
						<div class="fader" id="channel11" channel="11" value="0" max="255" onValueChanged="onChannelInput" label="11"></div>
						<div class="fader" id="channel12" channel="12" value="0" max="255" onValueChanged="onChannelInput" label="12"></div>
					</div>
				</div>

				<!-- Scenes -->
				<div class="col-3 d-flex align-items-start flex-column">
					<!-- Scene Option Buttons -->
					<div class="container-fluid d-flex justify-content-between m-2">
						<div id="buttonsEditScene" class="btn-group scene-edit">
							<button type="button" class="btn btn-primary" onclick="newScene()"><i class="bi-plus"></i></button>
						</div>
						
						<h3>Scenes</h3>

						<!-- Edit/Play Mode -->
						<div class="btn-group" role="group">
							<input type="radio" class="btn-check" name="selectMode" autocomplete="off" value="edit" id="selectModeEdit" checked>
							<label class="btn btn-secondary" for="selectModeEdit"><i class="bi-pencil"></i></label>

							<input type="radio" class="btn-check" name="selectMode" autocomplete="off" value="run" id="selectModeRun">
							<label class="btn btn-secondary" for="selectModeRun"><i class="bi-play"></i></label>
						</div>
					</div>

					<!-- Scenes Table -->
					<div class="container-fluid table-responsive" id="tableScenes">
						<table class="table table-bordered table-hover table-responsive" >
							<thead>
								<th><i class="bi-tag"></i></th>
								<th><i class="bi-clock"></i></th>
								<th class='scene-edit'></th>
							</thead>
							<tbody id="scenes">

							</tbody>
						</table>
					</div>

					<!-- Scenes Next/Prev Buttons -->
					<div class="container-fluid mt-auto d-flex scene-run">
						<button class="flex-fill btn btn-primary btn-lg btn-scene m-1" onclick="prevScene()"><i class="bi-caret-left"></i></button>
						<button class="flex-fill btn btn-primary btn-lg btn-scene m-1" onclick="nextScene()"><i class="bi-caret-right"></i></button>
					</div>
				</div>
			</div>
		</div>

		<!-- Edit Scene Attributes Modal -->
		<div class="modal" tabindex="-1" role="dialog" id="editSceneModal">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Scene</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="formEditScene">
							<input type="hidden" name="scene" />

							<div class="form-group">
								<label for="sceneName">Name</label>
								<input type="text" class="form-control" name="name" placeholder="Enter name">
							</div>
							<div class="form-group">
								<label for="sceneDuration">Transition Time (ms)</label>
								<input type="number" class="form-control" name="duration" value="0">
								
								<div>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="0">0 s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="250">¼ s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="500">½ s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="1000">1 s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="2000">2 s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="3000">3 s</button>
									<button type="button" class="btn btn-secondary btn-quick-duration" value="5000">5 s</button>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" id="btnEditSceneSave">Save</button>
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					</div>

				</div>
			</div>
		</div>

		<!-- Confirm Modal -->
		<div class="modal" tabindex="-1" id="confirmModal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title"></h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<p></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary modal-okay">OK</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
